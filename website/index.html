<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Python Bleach 2.0.0</title>
        <style>
         textarea, iframe {
             width: 95%;
         }
         #clean, #dirty, #ifr {
             height: 100px;
         }
         .test-case > .ifr {
             height: 50px;
         }
        </style>
    </head>
    <body>
        <h4>Python Bleach 2.0.0</h4>
        <p>
            <a href="http://badge.fury.io/py/bleach"><img style="max-width:100%;" alt="pypi version" src="https://badge.fury.io/py/bleach.svg"></a>
            <a href="https://travis-ci.org/mozilla/bleach"><img style="max-width:100%;" alt="Build Status" src="https://travis-ci.org/mozilla/bleach.svg?branch=master"></a>
        </p>
        <p>
        This is the demo for <a href="https://bleach.readthedocs.io/en/latest/index.html">Bleach</a>, a whitelist-based HTML sanitizing library that escapes or strips markup and attributes.
        Enter a sample payload in the textarea below and watch it sanitize in the textarea and iframe below.
        </p>
        <hr>
        <p><button id="unsafe-write">write <strong>unsanitized</strong> textarea value to DOM</button></p>
        <p><button id="clean-and-write">bleach.clean textarea value then write result to DOM</button></p>
        <p><input id="autoclean" type="checkbox" checked /> clean when dirty HTML changes</p>
        <hr>

        <div>
            <h4>Demo</h4>

            <p><label for="dirty">Dirty HTML</label></p>
            <textarea placeholder="Payload goes here." id="dirty"><!-- Loading Test-Vectors ... --></textarea>
            <p><label for="clean">Clean HTML</label></p>
            <textarea placeholder="Here be the sanitized markup to inspect!" id="clean"></textarea>
            <p><label for="ifr">Clean DOM</label></p>
            <iframe src="about:blank" id="ifr"></iframe>
        </div>

        <div id="test-template" class="test-case" style="display:none">
            <a class="test-name-link" href="#"><h4 class="test-name"></h4></a>

            <p><label for="dirty">Dirty HTML</label></p>
            <textarea placeholder="Payload goes here." class="dirty" readonly rows="2"></textarea>
            <p><label for="clean">Clean HTML</label></p>
            <textarea placeholder="Here be the sanitized markup to inspect!" class="clean" readonly rows="2"></textarea>
            <p><label for="ifr">Clean DOM</label></p>
            <iframe src="about:blank" class="ifr"></iframe>
        </div>

        <script>
         var writeToIframe = function(ifr, value) {
             ifr.contentDocument.open();
             ifr.contentDocument.write(value);
             ifr.contentDocument.close();
         };

         var sanitize = function() {
             var xhr = new XMLHttpRequest();
             xhr.open('POST', '/sanitize');
             xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
             xhr.onload = function() {
                 var sanitized = xhr.responseText;
                 document.querySelector('label[for=ifr]').textContent = "Clean DOM";
                 writeToIframe(document.getElementById('ifr'), sanitized);
                 clean.value = sanitized;
             }
             xhr.send(dirty.value);
         };

         var unsafeWrite = function() {
             clean.value = "N/A";
             document.querySelector('label[for=ifr]').textContent = "Dirty DOM";
             writeToIframe(document.getElementById('ifr'), dirty.value);
         };

         var addTest = function (test, index) {
             var testTemplate = document.getElementById('test-template');
             var template = testTemplate.cloneNode(true);
             var testId = 'test-' + index;
             template.setAttribute('id', testId);
             template.getElementsByClassName('test-name-link')[0].setAttribute('href', '#' + testId);
             template.getElementsByClassName('test-name')[0].textContent = test.title;
             template.getElementsByClassName('dirty')[0].value = test.payload;
             template.getElementsByClassName('clean')[0].value = test.actual;
             template.style.display = "block";

             // iframe must be in DOM before we can write to it.
             document.getElementsByTagName('body')[0].appendChild(template);

             writeToIframe(template.getElementsByClassName('ifr')[0], test.actual);
         };

         var loadTests = function(url, onSuccess) {
             var xhr = new XMLHttpRequest();
             xhr.open('GET', url);
             xhr.onload = function () {
                 return onSuccess(xhr.responseText);
             };
             xhr.onerror = function() {
                 console.error(arguments)
             }
             xhr.send(null);
         };

         document.getElementById('dirty')
                 .addEventListener('input', function () {
                     var autocleanEl = document.getElementById('autoclean');
                     if (autocleanEl.checked) {
                         sanitize();
                     }
         });

         document.getElementById('unsafe-write').addEventListener('click', unsafeWrite, false);
         document.getElementById('clean-and-write').addEventListener('click', sanitize, false);

         document.addEventListener('DOMContentLoaded', function() {
             loadTests('/testcases.json', function (responseText) {
                 dirty.value = '<!-- I am ready now, click one of the buttons! -->\r\n';

                 JSON.parse(responseText).forEach(addTest)
             });
         }, false);
        </script>
    </body>
</html>
